<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fancy MP3 Player</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: Arial, sans-serif;
        }
        .player-container {
            max-width: 600px;
            margin: 30px auto;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        .thumbnail {
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #6c757d;
            color: #fff;
            font-size: 1.5rem;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% {
                background-color: #6c757d;
            }
            50% {
                background-color: #adb5bd;
            }
        }
        .playlist {
            max-height: 300px;
            overflow-y: auto;
            padding: 15px;
        }
        .playlist-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #dee2e6;
        }
        .playlist-item:hover {
            background-color: #f1f3f5;
        }
    </style>
</head>
<body>

<div class="container player-container">
    <div class="thumbnail" id="thumbnail">Thumbnail</div>

    <div class="p-4">
        <audio id="audioPlayer" controls style="width: 100%;"></audio>
        <div class="mt-3">
            <label for="volume">Volume:</label>
            <input type="range" id="volume" min="0" max="1" step="0.01">
        </div>
    </div>

    <div class="playlist" id="playlist"></div>
</div>

<script>
    const playlistContainer = document.getElementById('playlist');
    const audioPlayer = document.getElementById('audioPlayer');
    const volumeControl = document.getElementById('volume');
    const thumbnail = document.getElementById('thumbnail');

    // Fetch songs dynamically from the server
    async function fetchSongs() {
        try {
            const response = await fetch('/songs');
            const songs = await response.json();

            playlistContainer.innerHTML = '';
            songs.forEach((song, index) => {
                const item = document.createElement('div');
                item.className = 'playlist-item';
                item.innerHTML = `
                    <span>${song.title}</span>
                    <div>
                        <button class="btn btn-sm btn-primary play-btn" data-src="${song.url}">Play</button>
                        <button class="btn btn-sm btn-success download-btn" data-src="${song.url}">Download</button>
                    </div>
                `;

                item.querySelector('.play-btn').addEventListener('click', () => playSong(song.url, song.title));
                item.querySelector('.download-btn').addEventListener('click', () => downloadSong(song.url));
                playlistContainer.appendChild(item);
            });
        } catch (error) {
            console.error('Failed to fetch songs:', error);
        }
    }

    function playSong(url, title) {
        audioPlayer.src = url;
        audioPlayer.play();
        thumbnail.textContent = `Now Playing: ${title}`;
    }

    function downloadSong(url) {
        const link = document.createElement('a');
        link.href = url;
        link.download = url.split('/').pop();
        link.click();
        incrementDownloadCount(url);
    }

    async function incrementDownloadCount(url) {
        try {
            await fetch('/increment-download', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ songUrl: url })
            });
        } catch (error) {
            console.error('Failed to increment download count:', error);
        }
    }

    volumeControl.addEventListener('input', (event) => {
        audioPlayer.volume = event.target.value;
    });

    // Fetch songs when the page loads
    document.addEventListener('DOMContentLoaded', fetchSongs);
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
